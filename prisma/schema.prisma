generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ───────────────────────────────────────────────
//  PLAYERS / TEAMS / PARTICIPANTS
// ───────────────────────────────────────────────
//

model Player {
  id                   String   @id @default(uuid())
  displayName          String
  nickname             String?
  birthDate            String?
  countryCode          String?
  contactEmail         String?  @unique
  preferredDisciplines String[]
  isActive             Boolean  @default(true)
  metadata             Json?

  teamMembers TeamMember[]
  participant Participant?

  @@map("players")
}

model Team {
  id          String  @id @default(uuid())
  displayName String
  shortCode   String?
  logoUrl     String?
  managerName String?
  minMembers  Int
  maxMembers  Int
  countryCode String?
  isActive    Boolean @default(true)
  metadata    Json?

  teamMembers TeamMember[]
  participant Participant?

  @@map("teams")
}

model TeamMember {
  id        String  @id @default(uuid())
  teamId    String
  playerId  String
  role      String?
  isCaptain Boolean @default(false)
  joinedAt  String
  leftAt    String?

  team   Team   @relation(fields: [teamId], references: [id])
  player Player @relation(fields: [playerId], references: [id])

  @@unique([teamId, playerId], name: "unique_member_per_team")
  @@map("team_members")
}

//
// ───────────────────────────────────────────────
//  PARTICIPANTS (player or team "normalized")
// ───────────────────────────────────────────────
//

model Participant {
  id          String          @id @default(uuid())
  type        ParticipantType
  playerId    String?         @unique
  teamId      String?         @unique
  displayName String
  countryCode String?
  seeding     Int?
  metadata    Json?

  player  Player?           @relation(fields: [playerId], references: [id])
  team    Team?             @relation(fields: [teamId], references: [id])
  entries TournamentEntry[]

  @@map("participants")
}

//
// ───────────────────────────────────────────────
//  TOURNAMENTS
// ───────────────────────────────────────────────
//

model Tournament {
  id                     String           @id @default(uuid())
  name                   String
  description            String?
  discipline             String
  format                 TournamentFormat
  status                 TournamentStatus
  allowMixedParticipants Boolean          @default(false)
  participantType        ParticipantType?
  maxParticipants        Int?
  startAt                String?
  endAt                  String?
  location               String?
  webhookUrl             String?
  metadata               Json?

  entries TournamentEntry[]
  groups  Group[]
  matches Match[]

  @@map("tournaments")
}

//
// ───────────────────────────────────────────────
//  ENTRIES (participants in tournaments)
// ───────────────────────────────────────────────
//

model TournamentEntry {
  id            String                @id @default(uuid())
  tournamentId  String
  participantId String
  status        TournamentEntryStatus
  groupId       String?
  seed          Int?
  metadata      Json?

  tournament  Tournament  @relation(fields: [tournamentId], references: [id])
  participant Participant @relation(fields: [participantId], references: [id])
  group       Group?      @relation(fields: [groupId], references: [id])

  @@unique([tournamentId, participantId], name: "unique_entry_per_tournament")
  @@map("tournament_entries")
}

//
// ───────────────────────────────────────────────
//  GROUPS (round robin or swiss pools)
// ───────────────────────────────────────────────
//

model Group {
  id           String @id @default(uuid())
  tournamentId String
  name         String
  metadata     Json?

  tournament   Tournament        @relation(fields: [tournamentId], references: [id])
  participants TournamentEntry[]

  @@map("groups")
}

//
// ───────────────────────────────────────────────
//  MATCHES
// ───────────────────────────────────────────────
//

model Match {
  id           String            @id @default(uuid())
  tournamentId String
  roundNumber  Int
  stage        String?
  bestOf       Int?
  scheduledAt  String?
  completedAt  String?
  format       TournamentFormat?
  participants Json // [{ participantId, score, ... }]
  metadata     Json?

  tournament Tournament @relation(fields: [tournamentId], references: [id])

  @@map("matches")
}

//
// ───────────────────────────────────────────────
//  ENUMS
// ───────────────────────────────────────────────
//

enum ParticipantType {
  PLAYER
  TEAM
}

enum TournamentFormat {
  SINGLE_ELIMINATION
  DOUBLE_ELIMINATION
  ROUND_ROBIN
  SWISS
}

enum TournamentStatus {
  DRAFT
  PUBLISHED
  STARTED
  COMPLETED
  CANCELLED
}

enum TournamentEntryStatus {
  PENDING
  CONFIRMED
  CANCELLED
  WITHDRAWN
}
